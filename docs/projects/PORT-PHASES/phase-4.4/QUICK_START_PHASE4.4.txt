===== COPY THIS INTO FRESH CLAUDE CODE SESSION FOR PHASE 4.4 =====

ROLE: You are a TypeScript developer implementing the script-based tool harness.

PROJECT: Codex TypeScript port - adding script harness for LLM tool composition.

STRATEGY: Test-Driven Development following merged expert design.

CURRENT PHASE: Phase 4.4 - Script Harness Core Implementation (5 weeks, 14 modules)

PREREQUISITES:
- Phase 4.2 ✅ (Anthropic Messages API - 148 tests)
- Phase 4.3 ✅ (Backend services & MCP - 34 tests)

IMMEDIATE TASKS BEFORE STARTING SCRIPT HARNESS:

Task 1: Fix Phase 4.2 cleanup errors
1. Run: npm test -- retry.test.ts
2. Identify cleanup issues (likely AbortController/timers not cleared)
3. Fix: Add proper cleanup in afterEach or test teardown
4. Verify: npm test -- messages (should show 0 errors)
5. Commit: git add -A && git commit -m "fix: cleanup errors in retry tests" && git push

Task 2: Complete Phase 4.2 missing tests
1. Review MESSAGES_API_INTEGRATION_DESIGN_CODEX.md Section 4.3 (RP tests)
2. Implement messages/response-parser.ts (non-streaming response parsing)
3. Write tests RP-01 through RP-20 (20 tests for complete responses)
4. Verify: npm test -- response-parser (all passing)
5. Update: Phase 4.2 now 167/167 tests complete
6. Commit: git add -A && git commit -m "phase4.2: add missing response parser (Stage 6)" && git push

THEN proceed with script harness implementation.

NOTE: Workspace is /Users/leemoore/code/codex-port-02
(TypeScript port is in codex-ts/ subdirectory)

CRITICAL: Read the FINAL design document FIRST
- Read SCRIPT_HARNESS_DESIGN_FINAL.md (complete merged design)
- This is THE definitive specification - follow it precisely
- 1,415 lines combining best of 3 expert consultations

THEN: Read phase documentation
- Read PORT-PHASES/phase-4.4/README.md (phase plan)
- Read PORT-PHASES/phase-4.4/STATUS.md (current progress)
- Read PORT-PHASES/phase-4.4/CHECKLIST.md (detailed tasks)

IMPLEMENTATION APPROACH: 5-week plan, 14 modules

Week 1: Runtime + Hardening
- QuickJS worker manager
- Memory/timeout limits
- Intrinsic freezing
- Promise tracker

Week 2: Detection + Parsing
- XML tag detection (<tool-calls> ONLY, no fences)
- Validation
- Extract scripts

Week 3: Tool Facade + Context
- Tool proxy (applyPatch, exec, fileSearch)
- Argument validation
- Context factory
- Promise lifecycle

Week 4: Approval Integration
- Approval bridge
- Pause/resume mechanism
- Denial handling

Week 5: Orchestration + Integration
- Main coordinator
- Serialization
- Wire into response processing
- Feature flags

WORKFLOW PER MODULE:
1. Read design section
2. Create test file FIRST
3. Write tests from design specs (S1-S15, F1-F20, I1-I5)
4. Run: npm test (should fail)
5. Implement until tests pass
6. Run: npm test (must pass!)
7. Type check: npx tsc --noEmit
8. Format: npm run format
9. Commit: git add -A && git commit -m "phase4.4: [MODULE]" && git push
10. Update CHECKLIST.md
11. Update STATUS.md
12. Update PORT_LOG_MASTER.md

IMPORTANT: XML tags ONLY
- Use <tool-calls>...</tool-calls>
- NO fenced blocks (```ts)
- Lesson from team-bruce: supporting 2 formats = complexity nightmare

TARGET: 40 tests (15 security, 20 functional, 5 integration)

DEV STANDARDS:
- Use npm (not pnpm/bun)
- TypeScript strict mode
- Prettier formatting
- 100% test pass rate
- JSDoc comments

BEFORE ENDING SESSION:
1. Update PORT-PHASES/phase-4.4/CHECKLIST.md
2. Update PORT-PHASES/phase-4.4/STATUS.md
3. Update codex-ts/PORT_LOG_MASTER.md
4. git add -A && git commit -m "phase4.4: [what you did]" && git push
5. Report: modules done, tests passing, what's next

START by reading STATUS.md, then begin with runtime/types.ts (foundation).
