===== COPY THIS INTO FRESH CLAUDE CODE SESSION FOR PHASE 4.7 =====

ROLE: You are a TypeScript developer implementing web search and document tools.

PROJECT: Codex TypeScript port - web search with caching and agent orchestration.

STRATEGY: Perplexity search, Firecrawl scraping, OpenRouter for LLM calls.

CURRENT PHASE: Phase 4.7 - Web Search & Orchestration Tools (10 tools)

PHASE 4.6 STATUS: ✅ COMPLETE (11 tools + tool packs)

NOTE: Workspace is /Users/leemoore/code/codex-port-02
(TypeScript port is in codex-ts/ subdirectory)

⚠️ ENVIRONMENT VARIABLES - CRITICAL:
The environment will be pre-configured with these variables:
- PERPLEXITY_API_KEY (webSearch)
- FIRECRAWL_API_KEY (fetchUrl)
- OPENROUTER_API_KEY (agents.llm.chat)
- TEST_MODEL_FLASH=google/gemini-2.0-flash-001
- TEST_MODEL_NANO=openai/gpt-5-nano
- TEST_MODEL_HAIKU=anthropic/claude-haiku-4.5

RULES:
1. USE environment variables AS-IS (process.env.PERPLEXITY_API_KEY, etc.)
2. DO NOT modify or override env vars
3. DO NOT try to extract API keys manually
4. If env vars missing/broken: STOP and inform user
5. DO NOT get creative trying to make things work
6. Default ALL testing to: process.env.TEST_MODEL_FLASH

FIRST: Read documentation
- Read PORT-PHASES/phase-4.7/README.md
- Read PORT-PHASES/phase-4.7/CHECKLIST.md
- Read PORT-PHASES/phase-4.7/STATUS.md

TOOLS TO IMPLEMENT:

Full Implementation (3):
1. webSearch - Perplexity API
2. fetchUrl - Firecrawl API + in-memory cache (Map, not Redis)
3. agents.llm.chat - OpenRouter chat completions

Stubs with Interfaces (7):
4. saveToFC
5. fetchFromFC
6. writeFile
7. prompts.save
8. prompts.get
9. agents.launch.sync
10. agents.launch.async

DEPENDENCIES:
npm install @perplexity-ai/sdk firecrawl-api

NO Redis - use in-memory Map for caching.

WORKFLOW:
1. Implement webSearch (Perplexity)
2. Implement fetchUrl (Firecrawl + Map cache)
3. Implement agents.llm.chat (OpenRouter, use team-bruce pattern)
4. Create 7 stubs (proper interfaces, mock returns)
5. Add all 10 to tool registry
6. Test everything

TESTING:
- Use process.env.TEST_MODEL_FLASH for all tests
- Mock API calls in tests (don't hit real APIs in test suite)
- Verify interfaces work

BEFORE ENDING SESSION:
1. Update PORT-PHASES/phase-4.7/CHECKLIST.md
2. Update PORT-PHASES/phase-4.7/STATUS.md
3. Update codex-ts/PORT_LOG_MASTER.md
4. git add -A && git commit -m "phase4.7: [what you did]" && git push
5. Report: tools implemented, what's stubbed, what's next

START with webSearch (Perplexity integration).

⚠️ If env vars don't work, STOP immediately - don't try to fix.
